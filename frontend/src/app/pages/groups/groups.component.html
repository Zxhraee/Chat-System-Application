<h2 class="page-title">Groups</h2>

<section *ngIf="canCreateGroup()" class="section narrow">
  <h3 class="section-title">Create group</h3>
  <form (ngSubmit)="createGroup()" class="create-form">
    <input [(ngModel)]="newGroupName" name="groupName" placeholder="Group name" required />
    <button type="submit" class="btn btn-accent">Create</button>
  </form>
</section>

<section *ngIf="isSuper" class="section narrow">
  <h3 class="section-title">Upgrade user to SUPER</h3>
  <div class="create-form">
    <select name="upgradeUser" [ngModel]="upgradeUserIdGlobal" (ngModelChange)="upgradeUserIdGlobal = $event">
      <option [ngValue]="null">Select user…</option>

      <option *ngFor="let u of allUsers" [hidden]="(u?.role || '').toUpperCase() === 'SUPER_ADMIN'" [ngValue]="u.id">
        {{ u.username }}
      </option>
    </select>

    <button class="btn btn-accent" (click)="addSuper()" [disabled]="!upgradeUserIdGlobal">
      Upgrade
    </button>
  </div>
  <br><br>
  <h3 class="section-title">Remove user from Application</h3>
  <div class="create-form">
    <select [ngModel]="removeUserIdGlobal" (ngModelChange)="removeUserIdGlobal = $event" name="removeUserGlobal">
      <option [ngValue]="null">Select member…</option>
      <option *ngFor="let u of allUsers" [hidden]="(u?.role || '').toUpperCase() === 'SUPER_ADMIN'" [ngValue]="u.id">
        {{ displayName(u) }}
      </option>
    </select>
    <button class="btn btn-accent" (click)="removeAnyUserGlobal()" [disabled]="!removeUserIdGlobal">
      Remove
    </button>
  </div>

</section>


<section class="section wide">
  <h3 class="section-title">My Groups</h3>

  <div *ngIf="myGroups.length === 0" class="empty-msg">
    You’re not in any groups yet.
  </div>

  <ul class="groups-grid">
    <li *ngFor="let g of myGroups" class="group-card">
      <div class="group-head">
        <div class="group-title">
          <strong class="group-name">{{ g.name }}</strong>
        </div>
        <div class="group-badges">
          <span class="badge" *ngIf="isSuper">Super</span>
          <span class="badge" *ngIf="isCreator(g)">Creator</span>
          <span class="badge" *ngIf="isAdmin(g)">Admin</span>
        </div>
      </div>

      <div class="group-actions">
        <button class="btn btn-danger" (click)="leave(g.id)" *ngIf="!isCreator(g) && !isGeneralGroup(g) && !isSuper">
          Leave
        </button>
        <button class="btn btn-subtle" (click)="rename(g)" *ngIf="canModify(g) && !isGeneralGroup(g)">Rename</button>
        <button class="btn btn-danger-outline" (click)="remove(g.id)" *ngIf="canModify(g) && !isGeneralGroup(g)">
          Delete
        </button>
      </div>

      <div *ngIf="canAdmin(g) && !isGeneralGroup(g)" class="admin-panel">
        <div class="row">
          <label class="label">Add member</label>
          <div class="controls">
            <select [ngModel]="getMap(addMemberUserId, g.id)" (ngModelChange)="setMap(addMemberUserId, g.id, $event)"
              name="add-{{g.id}}">
              <option [ngValue]="null">Select user…</option>
              <option *ngFor="let u of getAddableUsers(g.id)" [hidden]="(u?.role || '').toUpperCase() === 'SUPER_ADMIN'"
                [ngValue]="u.id">
                {{ displayName(u) }}
              </option>
            </select>
            <button class="btn btn-accent" type="button" (click)="addMember(g.id)"
              [disabled]="!getMap(addMemberUserId, g.id)">
              Add
            </button>

          </div>
        </div>


        <div *ngIf="!isSuper && isAdmin(g)" class="row">
          <label class="label">Request Admin promotion</label>
          <div class="controls">
            <select [ngModel]="getMap(promoteUserId, g.id)" (ngModelChange)="setMap(promoteUserId, g.id, $event)"
              name="prom-{{g.id}}">
              <option [ngValue]="null">Select member…</option>
              <option *ngFor="let u of getPromotableUsers(g.id)" [ngValue]="u.id">
                {{ displayName(u) }}
              </option>
            </select>
            <button class="btn" (click)="requestPromotion(g.id)" [disabled]="!getMap(promoteUserId, g.id)">
              Request
            </button>
          </div>
        </div>

        <div *ngIf="isSuper" class="row">
          <label class="label">Promote User</label>
          <div class="controls">
            <select [ngModel]="getMap(promoteUserId, g.id)" (ngModelChange)="setMap(promoteUserId, g.id, $event)"
              name="sp-{{g.id}}">
              <option [ngValue]="null">Select member…</option>
              <option *ngFor="let u of getPromotableUsers(g.id)" [ngValue]="u.id">
                {{ displayName(u) }}
              </option>
            </select>
            <button class="btn btn-accent" (click)="promoteNow(g.id)" [disabled]="!getMap(promoteUserId, g.id)">
              Promote
            </button>
          </div>
        </div>


        <div class="row">
          <label class="label">Delete from Group</label>
          <div class="controls">
            <select [ngModel]="getMap(removeUserId, g.id)" (ngModelChange)="setMap(removeUserId, g.id, $event)"
              name="rm-{{g.id}}">
              <option [ngValue]="null">Select member…</option>
              <option *ngFor="let u of getRemovableUsers(g.id)" [ngValue]="u.id">
                {{ displayName(u) }}
              </option>
            </select>
            <button class="btn btn-subtle" (click)="removeMemberFromGroup(g.id)"
              [disabled]="!getMap(removeUserId, g.id)">
              Delete
            </button>
          </div>
        </div>
        <div class="row">
          <label class="label">Channels</label>
          <div class="controls">
            <button class="btn" (click)="addChannel(g.id)">Add channel</button>
            <div class="stack">
              <select (click)="loadChannels(g.id)" [ngModel]="getMap(removeChannelId, g.id)"
                (ngModelChange)="setMap(removeChannelId, g.id, $event)" name="rc-{{g.id}}">
                <option [ngValue]="null">Select channel…</option>
                <option *ngFor="let c of channelsOf(g.id)" [value]="c.id">
                  {{ c.name }} ({{ c.id }})
                </option>
              </select>
              <button class="btn btn-subtle" (click)="removeChannel(g.id)">Remove</button>
            </div>
          </div>
        </div>


        <div class="danger-panel">
          <h4 class="subheading">Ban user & report</h4>
          <div class="row">
            <label class="label">Channel</label>
            <div class="controls">
              <select [ngModel]="getMap(banChannel, g.id)"
                (ngModelChange)="setMap(banChannel, g.id, $event); onBanChannelChange(g.id, $event)" name="bc-{{g.id}}">
                <option [ngValue]="null">Select channel…</option>
                <option *ngFor="let c of channelsOf(g.id)" [ngValue]="c.id">
                  {{ c.name }} ({{ c.id }})
                </option>
              </select>

            </div>
          </div>
          <div class="row">
            <label class="label">User</label>
            <div class="controls">
              <select [ngModel]="getMap(banUserId, g.id)" (ngModelChange)="setMap(banUserId, g.id, $event)"
                name="bu-{{g.id}}">
                <option [ngValue]="null">Select user…</option>
                <option *ngFor="let u of bannableUsersForSelectedChannel(g.id)" [ngValue]="u.id">
                  {{ displayName(u) }}
                </option>
              </select>

            </div>
          </div>
          <div class="row">
            <label class="label">Reason</label>
            <div class="controls">
              <input [ngModel]="banReason.get(g.id) || ''" (ngModelChange)="banReason.set(g.id, $event)"
                name="br-{{g.id}}" placeholder="reason" />
              <button class="btn btn-danger" (click)="banInChannel(g.id)"
                [disabled]="!(banChannel.get(g.id)) || !getMap(banUserId, g.id) || !(banReason.get(g.id))">
                Ban & Report
              </button>
            </div>
          </div>

<div class="row unban-section" *ngIf="isSuper">
  <label class="label">Banned</label>
  <div class="controls">

    <ng-container *ngIf="getMap(banChannel, g.id) as chId; else pickAChannel">

      <div class="banned-list" *ngIf="getBannedUsers(g.id).length; else noneBanned">
        <div class="banned-item" *ngFor="let u of getBannedUsers(g.id)">
          <span>{{ displayName(u) }}</span>
          <button
            class="btn btn-danger-outline"
            (click)="unbanInSelectedChannel(g.id, u.id)"
            [disabled]="isUnbanning(chId, u.id)"
            title="Remove ban from this channel"
          >
            {{ isUnbanning(chId, u.id) ? 'Unbanning…' : 'Unban' }}
          </button>
        </div>
      </div>

      <ng-template #noneBanned>
        <div class="pending">No one is banned in this channel.</div>
      </ng-template>
    </ng-container>

    <ng-template #pickAChannel>
      <div class="pending">Pick a channel above to manage bans.</div>
    </ng-template>
  </div>
</div>
        </div>




        <h4 *ngIf="isSuper" class="subheading">Pending Admin promotions</h4>
        <div class="pending" *ngIf="isSuper && getList(promoteRequests, g.id).length === 0">None</div>
        <ng-container *ngIf="isSuper">
          <div class="pending-item" *ngFor="let uid of getList(promoteRequests, g.id)">
            <span>{{ username(uid) }}</span>
            <div class="controls">
              <button class="btn btn-accent" (click)="approvePromotion(g.id, uid)">Approve</button>
              <button class="btn btn-subtle" (click)="rejectPromotion(g.id, uid)">Reject</button>
            </div>
          </div>
        </ng-container>
      </div>
    </li>
  </ul>
</section>

<section *ngIf="!isSuper && discoverGroups.length" class="discover card">
  <h3 class="card-title">All groups</h3>
  <ul class="discover-list">
    <li *ngFor="let g of discoverGroups" class="discover-item">
      <strong class="discover-name">{{ g.name }}</strong>
      <button (click)="requestToJoin(g.id)" [disabled]="isInGroup(g.id) || hasPendingJoin(g.id)" class="discover-join">
        Request to join
      </button>
    </li>
  </ul>
</section>

<section *ngIf="isSuper" class="section wide" style="margin-top:2rem">
  <h3 class="section-title">Ban reports</h3>

  <div *ngIf="!banReportsAll?.length" class="empty-msg">No bans recorded.</div>

  <div *ngIf="banReportsAll?.length">
    <table class="table ban-table">
      <thead>
        <tr>
          <th>When</th>
          <th>Group</th>
          <th>Channel</th>
          <th>User</th>
          <th>Banned by</th>
          <th>Reason</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of banReportsAll">
          <td>{{ r.createdAt | date:'d MMM y, h:mm a' }}</td>
          <td>{{ r.groupName }}</td>
          <td>{{ r.channelName }}</td>
          <td>{{ r.username }} ({{ r.userId }})</td>
          <td>{{ r.bannedByName }}</td>
          <td>{{ r.reason }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>